#!/bin/bash -e

if ! $(grep "https://github.com/PatrikAAberg/dmce-examples.git" .git/config &>/dev/null); then
    echo "Please execute this script from the dmce-examples git root"
    exit 1
fi

if [ ! -f "${HOME}/.dmceconfig" ]; then
    echo "${HOME}/.dmceconfig not found, please run dmce-configure-local or dmce-configure-global"
    exit 1
fi

if [ ! -f "/usr/share/dmce/dmce-probe-user-atexit.c" ]; then
    echo "The trace probe dmce-probe-user-atexit.c was not found at the specified path in ${HOME}/.dmceconfig"
    echo "Please run dmce-configure-global (available through dmce package install) or manually update the following configurations in ${HOME}/.dmceconfig:"
    echo "DMCE_PROBE_SOURCE:path-to-my-dmce-directory/dmce-probe-user-atexit.c"
    echo "DMCE_PROBE_PROLOG:path-to-my-dmce-directory/dmce-prolog-default.c"
    echo "DMCE_NUM_DATA_VARS:0"
    exit 1
fi

cat ${HOME}/.dmceconfig | grep -vE '^$|#|DMCE_PROBE_SOURCE|DMCE_PROBE_PROLOG|DMCE_NUM_DATA_VARS' > ./.dmceconfig

echo "DMCE_PROBE_SOURCE:/usr/share/dmce/dmce-probe-user-atexit.c" >> .dmceconfig
echo "DMCE_PROBE_PROLOG:/usr/share/dmce/dmce-prolog-default.c" >> .dmceconfig
echo "DMCE_NUM_DATA_VARS:0" >> .dmceconfig

echo "patchcov" > /home/$USER/.config/dmce.include

echo "Successfully created a .dmceconfig in this git for the patch coverage example"
